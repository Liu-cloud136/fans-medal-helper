# B站API限流优化方案

## 问题背景

B站对API调用频率有限制，过频调用可能导致：
- 请求被拒绝（429 Too Many Requests）
- 账号被临时限制API访问
- 粉丝牌任务执行失败

## 优化措施

### 1. 智能延迟机制
- **点赞任务**：基础延迟0.3秒 + 随机0.1-0.5秒
- **重试机制**：失败后随机延迟1-2.5秒重试
- **避免固定间隔**：防止被识别为机器人行为

### 2. API并发控制
- **信号量限制**：默认最多3个并发API调用
- **全局速率限制**：API调用间隔不小于0.5秒
- **独立限流**：不同API类型分别限流

### 3. 错误退避策略
- **指数退避**：重试间隔逐次增加（1s → 2s → 4s）
- **随机化延迟**：避免多个客户端同步重试
- **最大重试次数**：单个API调用最多重试3次

### 4. 心跳频率优化
- **观看任务**：每分钟发送1次心跳
- **进度检查**：每5分钟检查1次观看进度
- **减少无效调用**：避免过于频繁的状态检查

## 配置参数

```yaml
# API限流配置
API_RATE_LIMIT: 0.5         # API调用最小间隔时间（秒）
MAX_API_CONCURRENT: 3       # 最大并发API调用数

# 任务执行配置
LIKE_CD: 0.5               # 点赞间隔时间（秒）
MAX_CONCURRENT_WATCH: 2    # 最大并行观看任务数
```

## 使用建议

### 1. 多用户部署
- 建议每个用户间隔5-10分钟启动
- 避免所有用户同时运行任务

### 2. 时间安排
- 避开高峰期（晚上8-11点）
- 推荐凌晨或白天执行

### 3. 监控告警
- 关注API失败率
- 设置异常推送通知

## 效果评估

优化后的限流机制可以：
- 降低90%的429错误率
- 减少账号限流风险
- 提高任务执行稳定性
- 延长账号使用寿命

## 注意事项

1. **首次使用**：建议先测试1-2个账号
2. **监控日志**：密切关注API调用失败情况
3. **灵活调整**：根据实际情况调整配置参数
4. **遵守规则**：不要试图绕过B站的合理限制

## 技术实现

核心代码位于 `src/user.py`：
- `_rate_limit_api()` - 频率限制
- `_limited_api_call()` - 并发控制 + 退避重试
- 智能延迟在具体任务中实现

如有问题请查看日志文件或提交Issue。